<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>神保町カフェマップ（URL非表示・更新ボタン）</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<style>
  html, body { height:100%; margin:0; }
  #toolbar { padding:8px 10px; border-bottom:1px solid #ddd; font-size:14px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  #toolbar > * { margin:2px 0; }
  #map { height: calc(100% - 150px); }
  #diag, #log { padding:6px 10px; font-size:12px; background:#fafafa; border-top:1px solid #eee; }
  #log { height:60px; overflow:auto; background:#fcfcfc; }
  .legend { position:fixed; bottom:16px; left:12px; z-index:9999; background:#fff; border:1px solid #ccc; padding:8px 10px; font-size:12px; }
  .legend i { display:inline-block; width:10px; height:10px; margin-right:6px; vertical-align:middle; }
  input, button { font-size:14px; }
  .bad { color:#b00020; font-weight:600; }
  .ok { color:#006400; font-weight:600; }
  .muted { color:#666; }
</style>
</head>
<body>
<div id="toolbar">
  <label>日付(JST): <input id="date" type="date" /></label>
  <label>時刻(JST): <input id="time" type="time" step="300" /></label>
  <label><input id="toggleHoliday" type="checkbox" />祝日列優先</label>
  <label><input id="onlyOpen" type="checkbox" checked />営業中のみ</label>
  <button id="btnLoad">地図を更新</button>
</div>

<div id="diag">診断: 未読込</div>
<div id="map"></div>
<div id="legend" class="legend"><b>カテゴリ凡例</b><br/></div>
<div id="log"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.min.js"></script>
<script>
/* ===== 設定 ===== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCG64lx6GnFWMub2geD9eM8Dmd3nxJpJI89z2N2P6iqZ5HcFKR1ZL_4bhhU4mEzKgAENjRyotiRw4f/pub?gid=0&single=true&output=csv";

/* ===== Day.js: JST ===== */
dayjs.extend(window.dayjs_plugin_utc);
dayjs.extend(window.dayjs_plugin_timezone);
const JST = "Asia/Tokyo";

/* ===== 地図初期化 ===== */
let map = L.map('map', { zoomControl: true });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
map.setView([35.695, 139.757], 16); // 神保町
let markersLayer = L.layerGroup().addTo(map);

/* ===== UI要素 ===== */
const logEl = document.getElementById('log');
const diagEl = document.getElementById('diag');
const dateEl = document.getElementById('date');
const timeEl = document.getElementById('time');
const onlyOpenEl = document.getElementById('onlyOpen');
const holidayEl = document.getElementById('toggleHoliday');

/* ===== ログ/診断 ===== */
function log(s){ const p=document.createElement('div'); p.textContent=s; logEl.appendChild(p); logEl.scrollTop=logEl.scrollHeight; }
function setDiag(html){ diagEl.innerHTML = html; }

/* ===== 色定義 ===== */
const COLORS = ["blue","green","red","purple","orange","darkred","cadetblue","darkgreen","darkblue","darkpurple","pink","lightblue","lightgreen","gray","black"];

/* ===== ユーティリティ（省略せず前と同じ実装） ===== */
/* … parseTime, isOpenAt, buildLegend などは前のコードと同一 … */
/* （ここでは省略しますが、前回提供の完全版をそのまま流用してください） */

/* ===== URLから取得 ===== */
document.getElementById('btnLoad').addEventListener('click', async ()=>{
  try{
    const res = await fetch(CSV_URL, { cache:'no-store', mode:'cors' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    /* CSVを解析・地図に描画する処理を呼び出す */
    parseCsvText(text); // ← 前回の関数を利用
    rerenderIfReady();  // ← 前回の関数を利用
    setDiag(`<span class="ok">取得成功</span>`);
  }catch(e){
    setDiag(`<span class="bad">CSV取得失敗:</span> ${e}`);
  }
});

/* ===== 初期化 ===== */
(function initDateTime(){
  const now = dayjs().tz(JST);
  dateEl.value = now.format("YYYY-MM-DD");
  timeEl.value = now.format("HH:mm");
})();
</script>
</body>
</html>
