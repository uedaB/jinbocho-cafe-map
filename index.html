<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>神保町カフェマップ（日時分離・即時再描画）</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<style>
  html, body { height:100%; margin:0; }
  #toolbar { padding:8px 10px; border-bottom:1px solid #ddd; font-size:14px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  #toolbar > * { margin:2px 0; }
  #map { height: calc(100% - 170px); }
  #diag, #log { padding:6px 10px; font-size:12px; background:#fafafa; border-top:1px solid #eee; }
  #log { height:60px; overflow:auto; background:#fcfcfc; }
  .legend { position:fixed; bottom:16px; left:12px; z-index:9999; background:#fff; border:1px solid #ccc; padding:8px 10px; font-size:12px; }
  .legend i { display:inline-block; width:10px; height:10px; margin-right:6px; vertical-align:middle; }
  input, button { font-size:14px; }
  .bad { color:#b00020; font-weight:600; }
  .ok { color:#006400; font-weight:600; }
  .muted { color:#666; }
  @media (max-width: 520px){
    #map { height: calc(100% - 200px); }
    #csvUrl { width: 100%; max-width: 100%; }
  }
</style>
</head>
<body>
<div id="toolbar">
  <label>CSV URL:
    <input id="csvUrl" type="text" size="48"
      value="https://docs.google.com/spreadsheets/d/e/2PACX-1vQCG64lx6GnFWMub2geD9eM8Dmd3nxJpJI89z2N2P6iqZ5HcFKR1ZL_4bhhU4mEzKgAENjRyotiRw4f/pub?gid=0&single=true&output=csv" />
  </label>
  <button id="btnTest">疎通テスト</button>
  <button id="btnLoad">URLから読み込み</button>
  <br/>
  <label>日付(JST): <input id="date" type="date" /></label>
  <label>時刻(JST): <input id="time" type="time" step="300" /></label>
  <label title="祝日列（祝o/祝c）を当該日として使用"><input id="toggleHoliday" type="checkbox" />祝日列優先</label>
  <label title="ON: 営業中のみ / OFF: 全店表示"><input id="onlyOpen" type="checkbox" checked />営業中のみ</label>
</div>

<div id="diag">診断: 未読込</div>
<div id="map"></div>
<div id="legend" class="legend"><b>カテゴリ凡例</b><br/></div>
<div id="log"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.min.js"></script>
<script>
/* ===== Day.js: JST ===== */
dayjs.extend(window.dayjs_plugin_utc);
dayjs.extend(window.dayjs_plugin_timezone);
const JST = "Asia/Tokyo";

/* ===== 地図初期化 ===== */
let map = L.map('map', { zoomControl: true });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
map.setView([35.695, 139.757], 16); // 神保町
let markersLayer = L.layerGroup().addTo(map);

/* ===== UI要素 ===== */
const logEl = document.getElementById('log');
const diagEl = document.getElementById('diag');
const dateEl = document.getElementById('date');
const timeEl = document.getElementById('time');
const onlyOpenEl = document.getElementById('onlyOpen');
const holidayEl = document.getElementById('toggleHoliday');

/* ===== ログ/診断 ===== */
function log(s){ const p=document.createElement('div'); p.textContent=s; logEl.appendChild(p); logEl.scrollTop=logEl.scrollHeight; }
function setDiag(html){ diagEl.innerHTML = html; }

/* ===== 色定義 ===== */
const COLORS = ["blue","green","red","purple","orange","darkred","cadetblue","darkgreen","darkblue","darkpurple","pink","lightblue","lightgreen","gray","black"];

/* ===== ユーティリティ ===== */
function zen2han(s){
  const map={'０':'0','１':'1','２':'2','３':'3','４':'4','５':'5','６':'6','７':'7','８':'8','９':'9','：':':','．':'.','，':','};
  return s.replace(/[０-９：．，]/g, ch => map[ch] || ch);
}
function toNumberStrict(val){
  if (val==null) return NaN;
  let s = String(val).trim();
  if (!s) return NaN;
  s = zen2han(s).replace(/\s+/g,'').replace(/,/g,'');
  return parseFloat(s);
}

/* ===== 営業時間パース＆判定 ===== */
const CLOSED = new Set(["休","休み","定休","定休日","-","—","–","ー","×","なし","ナシ","休業","close","closed"]);
function parseTime(raw){
  if (raw == null) return null;
  let s = String(raw).trim();
  if (!s) return null;
  s = zen2han(s).toLowerCase();
  for (const t of CLOSED){ if (s.includes(t)) return null; }
  let m = s.match(/(\d{1,2})\s*[:：]?\s*(\d{2})/);
  if (m){
    let hh=+m[1], mm=+m[2];
    if (hh===24 && mm===0) return {h:23, m:59};
    if (hh>=0 && hh<=23 && mm>=0 && mm<=59) return {h:hh, m:mm};
  }
  m = s.match(/(\d{1,2})\s*時/);
  if (m){
    let hh=+m[1];
    if (hh>=0 && hh<=23) return {h:hh, m:0};
  }
  return null;
}
function isOpenAt(row, dt, useHoliday, columns){
  const wd = dt.day(); // Sun=0
  const wdMap = {1:["月o","月c"], 2:["火o","火c"], 3:["水o","水c"], 4:["木o","木c"], 5:["金o","金c"], 6:["土o","土c"], 0:["日o","日c"]};
  let oCol, cCol, label;
  if (useHoliday && columns.includes("祝o") && columns.includes("祝c")){
    oCol="祝o"; cCol="祝c"; label="祝";
  } else {
    [oCol, cCol] = wdMap[wd]; label = "日月火水木金土"[wd];
  }
  const o = parseTime(row[oCol]);
  const c = parseTime(row[cCol]);
  if (!o || !c) return {open:false, label, oRaw:row[oCol], cRaw:row[cCol]};
  const oDT = dt.tz(JST).set('hour',o.h).set('minute',o.m).set('second',0).set('millisecond',0);
  let cDT = dt.tz(JST).set('hour',c.h).set('minute',c.m).set('second',0).set('millisecond',0);
  if (cDT.valueOf() <= oDT.valueOf()) cDT = cDT.add(1, 'day'); // 日跨ぎ
  const openNow = dt.valueOf() >= oDT.valueOf() && dt.valueOf() < cDT.valueOf();
  return {open:openNow, label, oRaw:row[oCol], cRaw:row[cCol]};
}

/* ===== 凡例 ===== */
function buildLegend(cat2color){
  const legend = document.getElementById('legend');
  legend.innerHTML = "<b>カテゴリ凡例</b><br/>";
  Object.entries(cat2color).forEach(([cat,col])=>{
    const line = document.createElement('div');
    line.innerHTML = `<i style="background:${col}"></i>${cat}`;
    legend.appendChild(line);
  });
}

/* ===== グローバル状態（CSVキャッシュ） ===== */
let cachedCsvText = null;
let cachedRows = null;
let cachedCols = null;

/* ===== 解析 → 描画（共通） ===== */
function parseAndRender_fromRows(rows, cols, nowJST, useHoliday, onlyOpen){
  const norm = rows.map(r=>{ const o={}; Object.keys(r).forEach(k=>o[String(k).trim()]=r[k]); return o; });

  const list = [];
  if (onlyOpen){
    norm.forEach(r=>{
      const res = isOpenAt(r, nowJST, useHoliday, cols);
      if (res.open) list.push({...r, __label:res.label, __oRaw:res.oRaw, __cRaw:res.cRaw});
    });
  } else {
    const wd = nowJST.day();
    const wdMap = {1:["月o","月c"], 2:["火o","火c"], 3:["水o","水c"], 4:["木o","木c"], 5:["金o","金c"], 6:["土o","土c"], 0:["日o","日c"]};
    let oCol, cCol, label;
    if (useHoliday && cols.includes("祝o") && cols.includes("祝c")){ oCol="祝o"; cCol="祝c"; label="祝"; }
    else { [oCol, cCol] = wdMap[wd]; label = "日月火水木金土"[wd]; }
    norm.forEach(r=> list.push({...r, __label:label, __oRaw:r[oCol], __cRaw:r[cCol]}));
  }

  // 中心を計算
  let latSum=0, lonSum=0, n=0;
  (list.length ? list : norm).forEach(r=>{
    const lat = toNumberStrict(r["緯度"]), lon = toNumberStrict(r["経度"]);
    if (!Number.isNaN(lat) && !Number.isNaN(lon)){ latSum+=lat; lonSum+=lon; n++; }
  });
  if (n>0) map.setView([latSum/n, lonSum/n], 16);

  // 描画
  markersLayer.clearLayers();

  // カテゴリ列（あれば使用）
  let catCol = cols.includes("カテゴリ") ? "カテゴリ" : (cols.find(c=> String(c).startsWith("カテゴリ")) || null);
  const cats = [...new Set(list.map(r=> (catCol ? String(r[catCol]||"未分類") : "未分類")))];
  const c2c = {}; cats.forEach((c,i)=> c2c[c] = COLORS[i % COLORS.length]); if (cats.length===0) c2c["未分類"] = "blue";
  buildLegend(c2c);

  let plotted=0;
  list.forEach(r=>{
    const lat = toNumberStrict(r["緯度"]), lon = toNumberStrict(r["経度"]);
    if (Number.isNaN(lat) || Number.isNaN(lon)) return;
    const cat = catCol ? String(r[catCol]||"未分類") : "未分類";
    const color = c2c[cat] || "blue";
    const hours = `${r.__label}: ${r.__oRaw??""} - ${r.__cRaw??""}`;
    const html = `<b>${r["名称"]}</b><br/>カテゴリ: ${cat}<br/>営業時間: ${hours}<br/>対象日時: ${nowJST.format("YYYY-MM-DD HH:mm")}`;
    const icon = L.icon({
      iconUrl:`https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
      shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
      iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
    });
    L.marker([lat,lon], {icon}).bindPopup(html).addTo(markersLayer);
    plotted++;
  });

  setDiag(`行数:${norm.length} ／ 描画ピン:${plotted} ／ 列:${cols.join(" | ")}`);
  if (plotted===0) L.popup().setLatLng(map.getCenter()).setContent("該当時刻に営業中なし、または緯度/経度が不正です。").openOn(map);
}

/* ===== 文字列CSV → 行配列にパース ===== */
function parseCsvText(text){
  const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
  const rows = parsed.data;
  const cols = (parsed.meta?.fields || []).map(s => String(s).trim());
  const must = ["名称","緯度","経度"];
  const miss = must.filter(c => !cols.includes(c));
  if (miss.length){
    setDiag(`<span class="bad">必須列不足:</span> ${miss.join(", ")} ／ 検出: ${cols.join(" | ")}`);
    cachedRows = null; cachedCols = null;
    return;
  }
  cachedRows = rows;
  cachedCols = cols;
}

/* ===== 現在のUIから JST日時を生成 ===== */
function buildCurrentJST(){
  // 日付と時刻が両方あれば結合、どちらか欠けていれば現在時刻
  const d = dateEl.value;
  const t = timeEl.value;
  if (d && t){
    const iso = `${d}T${t}`;
    return dayjs.tz(iso, JST);
  } else if (d){
    return dayjs.tz(d, JST);
  } else {
    return dayjs().tz(JST);
  }
}

/* ===== 再描画（CSV再取得なし） ===== */
function rerenderIfReady(){
  if (!cachedRows || !cachedCols) return;
  const nowJST = buildCurrentJST();
  const useHoliday = holidayEl.checked;
  const onlyOpen = onlyOpenEl.checked;
  parseAndRender_fromRows(cachedRows, cachedCols, nowJST, useHoliday, onlyOpen);
}

/* ===== URLから取得 ===== */
document.getElementById('btnLoad').addEventListener('click', async ()=>{
  const url = document.getElementById('csvUrl').value.trim();
  try{
    const res = await fetch(url, { cache:'no-store', mode:'cors', redirect:'follow', credentials:'omit', referrerPolicy:'no-referrer' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text(); // 公開CSVはUTF-8
    cachedCsvText = text;
    parseCsvText(text);
    rerenderIfReady();
    setDiag(`<span class="ok">取得成功</span>`);
  }catch(e){
    setDiag(`<span class="bad">CSV取得失敗:</span> ${e}`);
  }
});

/* ===== 疎通テスト ===== */
document.getElementById('btnTest').addEventListener('click', ()=>{
  const url = document.getElementById('csvUrl').value.trim();
  window.open(url, '_blank', 'noopener');
});

/* ===== 入力変更で即時再描画（CSV再取得なし） ===== */
dateEl.addEventListener('change', rerenderIfReady);
timeEl.addEventListener('change', rerenderIfReady);
onlyOpenEl.addEventListener('change', rerenderIfReady);
holidayEl.addEventListener('change', rerenderIfReady);

/* ===== 初期化：今日のJSTと現在時刻をセット ===== */
(function initDateTime(){
  const now = dayjs().tz(JST);
  dateEl.value = now.format("YYYY-MM-DD");
  timeEl.value = now.format("HH:mm");
})();
</script>
</body>
</html>
